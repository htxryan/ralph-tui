# Research Codebase

You are tasked with conducting comprehensive research across the codebase to answer questions defined in a task file by spawning parallel sub-agents and synthesizing their findings.

## Arguments

This command accepts a required argument:

- **$ARGUMENTS**: The task ID (e.g., "my-task") corresponding to a task directory

Parse the arguments to extract:
- **task_id**: The task identifier (required) - corresponds to `.ai-docs/thoughts/plans/<task_id>/task.md`

If no task_id is provided, respond:
```
Error: Task ID required.

Usage: /refine/research_codebase <task-id>

Example: /refine/research_codebase my-feature

The task ID corresponds to a task directory containing:
- Input:  .ai-docs/thoughts/plans/<task-id>/task.md (required - defines the research assignment)
- Output: .ai-docs/thoughts/plans/<task-id>/research.md (generated by this command)
```
Then stop and wait for correct input.

## CRITICAL: AUTONOMOUS EXECUTION - NEVER ASK QUESTIONS

**You MUST complete this command autonomously without asking clarifying questions.**

- **NEVER** ask the user questions during execution
- **NEVER** pause and wait for user input or confirmation
- **ALWAYS** make your best judgment when decisions arise
- **ALWAYS** produce a complete, valid research document as output
- If something is ambiguous, make a reasonable assumption and document it
- If you're unsure about scope, err on the side of being thorough
- The user will critique your output AFTER you produce it - do not pre-emptively ask for guidance
- Getting stuck waiting for user input is UNACCEPTABLE - always move forward

## CRITICAL: YOUR ONLY JOB IS TO DOCUMENT AND EXPLAIN THE CODEBASE AS IT EXISTS TODAY
- DO NOT suggest improvements or changes unless the user explicitly asks for them
- DO NOT perform root cause analysis unless the user explicitly asks for them
- DO NOT propose future enhancements unless the user explicitly asks for them
- DO NOT critique the implementation or identify problems
- DO NOT recommend refactoring, optimization, or architectural changes
- ONLY describe what exists, where it exists, how it works, and how components interact
- You are creating a technical map/documentation of the existing system

## Initial Setup:

When this command is invoked with a valid task_id:

1. **Validate the task file exists**:
   - Check for `.ai-docs/thoughts/plans/<task_id>/task.md`
   - If it does NOT exist, respond:
     ```
     Error: Task file not found.

     Expected: .ai-docs/thoughts/plans/<task_id>/task.md

     Please create the task file first with your research requirements, then run this command again.
     ```
     Then stop and wait.

2. **Read the task file FULLY**:
   - Read `.ai-docs/thoughts/plans/<task_id>/task.md` WITHOUT limit/offset
   - This file defines the research assignment - understand it completely
   - Extract the research question, scope, and any specific areas of focus

3. **Respond with confirmation**:
   ```
   I'm researching the codebase for task: <task_id>

   Task: .ai-docs/thoughts/plans/<task_id>/task.md
   Output: .ai-docs/thoughts/plans/<task_id>/research.md

   Based on the task file, I understand the research assignment is:
   [Summary of what task.md is asking for]

   Beginning research...
   ```

4. **Proceed directly to research** using the task.md content as your guide

## Steps to follow for research:

1. **Read any additional files mentioned in task.md:**
   - If task.md references specific files (designs, docs, JSON), read them FULLY first
   - **IMPORTANT**: Use the Read tool WITHOUT limit/offset parameters to read entire files
   - **CRITICAL**: Read these files yourself in the main context before spawning any sub-tasks
   - This ensures you have full context before decomposing the research

2. **Analyze and decompose the research assignment:**
   - Break down the task.md requirements into composable research areas
   - Take time to ultrathink about the underlying patterns, connections, and architectural implications
   - Identify specific components, patterns, or concepts to investigate
   - Create a research plan using TodoWrite to track all subtasks
   - Consider which directories, files, or architectural patterns are relevant

3. **Spawn parallel sub-agent tasks for comprehensive research:**
   - Create multiple Task agents to research different aspects concurrently
   - We have specialized agents that know how to do specific research tasks:

   **For codebase research:**
   - Use the **codebase-locator** agent to find WHERE files and components live
   - Use the **codebase-analyzer** agent to understand HOW specific code works (without critiquing it)
   - Use the **codebase-pattern-finder** agent to find examples of existing patterns (without evaluating them)

   **IMPORTANT**: All agents are documentarians, not critics. They will describe what exists without suggesting improvements or identifying issues.

   **For thoughts directory:**
   - Use the **thoughts-locator** agent to discover what documents exist about the topic
   - Use the **thoughts-analyzer** agent to extract key insights from specific documents (only the most relevant ones)

   **For web research (only if user explicitly asks):**
   - Use the **web-search-researcher** agent for external documentation and resources
   - IF you use web-research agents, instruct them to return LINKS with their findings, and please INCLUDE those links in your final report

   The key is to use these agents intelligently:
   - Start with locator agents to find what exists
   - Then use analyzer agents on the most promising findings to document how they work
   - Run multiple agents in parallel when they're searching for different things
   - Each agent knows its job - just tell it what you're looking for
   - Don't write detailed prompts about HOW to search - the agents already know
   - Remind agents they are documenting, not evaluating or improving

4. **Wait for all sub-agents to complete and synthesize findings:**
   - IMPORTANT: Wait for ALL sub-agent tasks to complete before proceeding
   - Compile all sub-agent results (both codebase and thoughts findings)
   - Prioritize live codebase findings as primary source of truth
   - Use .ai-docs/thoughts/ findings as supplementary historical context
   - Connect findings across different components
   - Include specific file paths and line numbers for reference
   - Highlight patterns, connections, and architectural decisions
   - Answer the task.md requirements with concrete evidence

5. **Gather metadata for the research document:**
   - Get current date: `date +%Y-%m-%d`
   - Get current git info: `git rev-parse --short HEAD` and `git branch --show-current`
   - **Output path**: `.ai-docs/thoughts/plans/<task_id>/research.md`

6. **Generate research document:**
   - Use the metadata gathered in step 5
   - **CRITICAL**: Write to `.ai-docs/thoughts/plans/<task_id>/research.md`
   - Structure the document with YAML frontmatter followed by content:
     ```markdown
     ---
     date: [Current date in YYYY-MM-DD format]
     task_id: "<task_id>"
     researcher: claude
     git_commit: [Current commit hash]
     branch: [Current branch name]
     topic: "[Topic from task.md]"
     tags: [research, codebase, relevant-component-names]
     status: complete
     ---

     # Research: [Topic from task.md]

     **Task ID**: <task_id>
     **Date**: [Current date]
     **Git Commit**: [Current commit hash]
     **Branch**: [Current branch name]

     ## Task Assignment
     [Summary of what task.md asked for]

     ## Summary
     [High-level documentation of what was found, answering the task requirements by describing what exists]

     ## Detailed Findings

     ### [Component/Area 1]
     - Description of what exists (`file.ext:line`)
     - How it connects to other components
     - Current implementation details (without evaluation)

     ### [Component/Area 2]
     ...

     ## Code References
     - `.ralph/tui/src/path/to/file.ts:123` - Description of what's there
     - `.ralph/tui/src/another/file.tsx:45-67` - Description of the code block

     ## Architecture Documentation
     [Current patterns, conventions, and design implementations found in the codebase]

     ## Historical Context (from .ai-docs/thoughts/)
     [Relevant insights from thoughts directory with references, if any exist]
     - `.ai-docs/thoughts/research/something.md` - Historical decision about X
     - `.ai-docs/thoughts/notes/exploration.md` - Past exploration of Y

     ## Related Documentation
     [Links to other relevant documents]
     - `.ai-docs/design/product-brief.md` - Product context
     - `.ai-docs/adr/relevant-adr.md` - Architectural decision

     ## Open Questions
     [Any areas that need further investigation]
     ```

7. **Add GitHub permalinks (if applicable):**
   - Check if on main branch or if commit is pushed: `git branch --show-current` and `git status`
   - If on main/master or pushed, generate GitHub permalinks:
     - Get repo info: `gh repo view --json owner,name`
     - Create permalinks: `https://github.com/{owner}/{repo}/blob/{commit}/{file}#L{line}`
   - Replace local file references with permalinks in the document

8. **Present findings:**
   - Present a concise summary of findings to the user
   - Include key file references for easy navigation
   - Confirm the research was saved:
     ```
     Research saved to: .ai-docs/thoughts/plans/<task_id>/research.md

     Next step: Run /refine/create_plan <task_id> to create an implementation plan based on this research.
     ```
   - Do NOT ask if they have questions - the output speaks for itself

9. **If user provides follow-up questions later:**
   - If the user later asks follow-up questions, append to the same research document
   - Update the frontmatter field `status` to reflect ongoing research if needed
   - Add a new section: `## Follow-up Research [YYYY-MM-DD]`
   - Spawn new sub-agents as needed for additional investigation
   - Continue updating the document autonomously without asking for clarification

## Directory Structure

This project uses `.ai-docs/thoughts/plans/` for task-based workflows:

```
.ai-docs/thoughts/plans/
└── <task_id>/
    ├── task.md       # Input: Defines the task/research assignment (created by user)
    ├── research.md   # Output: This command's research findings
    └── plan.md       # Output: Created by /refine/create_plan
```

Historical context and notes are stored in `.ai-docs/thoughts/`:
```
.ai-docs/thoughts/
├── research/        # General research documents
├── notes/           # General notes and explorations
└── decisions/       # Decision records and rationale
```

## Important notes:
- Always use parallel Task agents to maximize efficiency and minimize context usage
- Always run fresh codebase research - never rely solely on existing research documents
- The .ai-docs/thoughts/ directory provides historical context to supplement live findings
- Focus on finding concrete file paths and line numbers for developer reference
- Research documents should be self-contained with all necessary context
- Each sub-agent prompt should be specific and focused on read-only documentation operations
- Document cross-component connections and how systems interact
- Include temporal context (when the research was conducted)
- Link to GitHub when possible for permanent references
- Keep the main agent focused on synthesis, not deep file reading
- Have sub-agents document examples and usage patterns as they exist
- Check `.ai-docs/` directory for existing design docs, ADRs, and prompts
- **CRITICAL**: You and all sub-agents are documentarians, not evaluators
- **REMEMBER**: Document what IS, not what SHOULD BE
- **NO RECOMMENDATIONS**: Only describe the current state of the codebase
- **File reading**: Always read mentioned files FULLY (no limit/offset) before spawning sub-tasks
- **Task file is primary**: The task.md file defines your research assignment - follow it
- **Critical ordering**: Follow the numbered steps exactly
  - ALWAYS read task.md first before anything else
  - ALWAYS read mentioned files first before spawning sub-tasks (step 1)
  - ALWAYS wait for all sub-agents to complete before synthesizing (step 4)
  - ALWAYS gather metadata before writing the document (step 5 before step 6)
  - NEVER write the research document with placeholder values
- **Frontmatter consistency**:
  - Always include frontmatter at the beginning of research documents
  - Keep frontmatter fields consistent across all research documents
  - Update frontmatter when adding follow-up research
  - Use snake_case for multi-word field names (e.g., `git_commit`)
  - Tags should be relevant to the research topic and components studied
- **Output location**: Always write to `.ai-docs/thoughts/plans/<task_id>/research.md`

## Codebase Context

This is the Ralph TUI codebase - a terminal user interface for monitoring autonomous AI coding agents. Key areas to be aware of:

- **Main TUI application**: `.ralph/tui/src/` (Ink + React + TypeScript)
- **Core patterns**: Stream processing, subagent tracking, process management
- **AI documentation**: `.ai-docs/` (design docs, ADRs, prompts, thoughts)
- **Configuration**: `.claude/` (agents, commands, skills)

When researching, consider:
- React/Ink component patterns in `components/`
- Custom hooks in `hooks/`
- Type definitions in `lib/types.ts`
- JSONL parsing in `lib/parser.ts`

## Workflow

This command is part of the refinement workflow:
1. **`/refine/research_codebase <task-id>`** - Research and document (reads task.md, creates research.md)
2. `/refine/create_plan <task-id>` - Create implementation plan (reads task.md + research.md, creates plan.md)
3. `/refine/capture <task-id>` - Capture to Vibe Kanban issue
